<!DOCTYPE html>
<html>
  <head>
    <link href='/auxiliary.css' rel='stylesheet' type='text/css'>
    <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
    <title>Emotobooth History</title>
    <style>
    </style>
  </head>
  <body>

  <header>
    <h1>
      Emotobooth
    </h1>
  </header>

  <section>
    <button id="keep-button" class="keep-button" value="Keep" onClick="keep()">Keep</button>
    <button id="kill-button" class="kill-button" value="Kill" onClick="kill()">Kill</button>
  </section>

    <main class="main">

    </main>

    <script>

      let socket = io.connect('/');
      function keep() {
          socket.emit('endSession', {});
      }
      function kill() {
          socket.emit('killSession', {});
      }

      socket.on('session_processing', () => {
          document.getElementById('keep-button').setAttribute('disabled', 'disabled');
          document.getElementById('kill-button').setAttribute('disabled', 'disabled');
      });

      socket.on('session_processed', () => {
          document.getElementById('keep-button').removeAttribute('disabled');
          document.getElementById('kill-button').removeAttribute('disabled');
          updateSessions();
      });

      function deleteSession(e) {
        let xhr = new XMLHttpRequest();
        xhr.onreadystatechange = () => {
          e.target.parentElement.classList.add('deleted');
        };
        xhr.open('GET', '/delete-session/' + e.target.getAttribute('data-id'), true);
        xhr.send();
      }

      function updateSessions() {
          let xhr = new XMLHttpRequest();
          let sessions;
          let main = document.getElementsByClassName('main')[0];
          main.innerHTML = '';
          xhr.onreadystatechange = () => {
              if (xhr.readyState === XMLHttpRequest.DONE) {

                  sessions = JSON.parse(xhr.responseText);

                  sessions.sort((a, b) => {

                      a = JSON.parse(a);
                      b = JSON.parse(b);

                      return a.id < b.id;

                  });

                  sessions = sessions.slice(0, 10);

                  sessions.forEach((session) => {
                      session = JSON.parse(session);
                      sessionKeys = [];
                      sessionImages = [];

                      let sessDiv = document.createElement('div');
                      sessDiv.classList.add('session');
                      if (session.deleted) {
                          sessDiv.classList.add('deleted');
                      }

                      let title = document.createElement('h2');
                      if (!session.deleted) {
                          title.innerHTML = session.id;
                      } else {
                          title.innerHTML = `${ session.id } - DELETED`;
                      }
                      sessDiv.appendChild(title);

                      if (!session.deleted) {
                          let delButton = document.createElement('button');
                          delButton.setAttribute('data-id', session.id);
                          delButton.classList.add('delete-button');
                          delButton.innerHTML = 'DELETE';
                          delButton.addEventListener("click", deleteSession, false);
                          sessDiv.appendChild(delButton);
                      }


                      let sessionImgsWrap = document.createElement('div');
                      sessionImgsWrap.classList.add('history-images');
                      sessDiv.appendChild(sessionImgsWrap);

                      for (let key in session) {
                          if (session.hasOwnProperty(key) && typeof session[key] === 'object') {
                              sessionKeys.push(key.toString());
                          }
                      }

                      console.log(session);

                      sessionKeys.forEach((key) => {
                          sessionImages.push(session[key]);
                          const wrapper = document.createElement('div');
                          wrapper.classList.add('history-item');

                          const img = document.createElement('img');
                          img.classList.add('history-image');
                          img.setAttribute('src', session[key].finalPath);

                          const printButton = document.createElement('button');
                          printButton.innerText = 'Print';
                          printButton.classList.add('print-buttons');
                          printButton.addEventListener('click', (e) => {
                              e.preventDefault();
                              socket.emit('print', session[key])
                          });

                          wrapper.appendChild(img);
                          wrapper.appendChild(printButton);

                          sessionImgsWrap.appendChild(wrapper);
                      });

                      main.appendChild(sessDiv);
                  })
              }
          };
          xhr.open('GET', '/history-data', true);
          xhr.send();
      }

      updateSessions();

    </script>
  </body>
</html>
